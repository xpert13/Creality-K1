# K1
# Printer_size: 220x220x250
# Version: v1.0.25
# CreateDate: 2023/03/21
# Nozzle_mcu: chip: GD32F303CBT6
#             version: CR-K1-MAX-NOZZLE-V1.0.0
# Leveling_mcu: chip: GD32E230F8P6
#             version: CR-K1-MAX-LEVELING-V1.0.0
# mcu: chip: GD32F303RET6
#      version: CR4CU220812S12

[include sensorless.cfg]
[include gcode_macro.cfg]
[include printer_params.cfg]
[include cartographer_macro.cfg]
[include start_end.cfg]
[include start_macro.cfg]
[include start_macro.cfg]
[include start_macro.cfg]
[include start_macro.cfg]
[include GuppyScreen/*.cfg]
[include custom_macros.cfg]
[include screws_tilt.cfg]
[include KAMP_Settings.cfg]

[mcu]
serial: /dev/ttyS7
baud: 230400
restart_method: command

[mcu nozzle_mcu]
serial: /dev/ttyS1
baud: 230400
restart_method: command

[mcu leveling_mcu]
serial: /dev/ttyS9
baud: 230400
restart_method: command

[verify_heater extruder]
[verify_heater heater_bed]
check_gain_time: 120
heating_gain: 1.0
hysteresis: 10

[mcu rpi]
serial: /tmp/klipper_host_mcu

[cartographer]
serial: /dev/serial/by-id/usb-Cartographer_614e_270029000243304858353520-if00
speed: 40.                      #   Z probing dive speed.
lift_speed: 5.                  #   Z probing lift speed.
backlash_comp: 0.5              #   Backlash compensation distance for removing Z backlash before measuring the sensor response.
x_offset: 0.                    #   X offset of cartographer from the nozzle.
y_offset: 16.86                 #   Y offset of cartographer from the nozzle.
trigger_distance: 2.            #   cartographer triggers distance for homing.
trigger_dive_threshold: 1.5     #   Threshold for range vs dive mode probing. Beyond `trigger_distance + trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006       #   Hysteresis on trigger threshold for un triggering, as a percentage of the trigger threshold.
cal_nozzle_z: 0.1               #   Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1                  #   Minimum z bound on sensor response measurement.
cal_ceil:5.                     #   Maximum z bound on sensor response measurement.
cal_speed: 1.0                  #   Speed while measuring response curve.
cal_move_speed: 10.             #   Speed while moving to position for response curve measurement.
default_model_name: default     #   Name of default cartographer model to load.
mesh_main_direction: x          #   Primary travel direction during mesh measurement.
#mesh_overscan: -1              #   Distance to use for direction changes at mesh line ends. Omit this setting and a default will be calculated from line spacing and available travel.
mesh_cluster_size: 1            #   Radius of mesh grid point clusters.
mesh_runs: 2                    #   Number of passes to make during mesh scan.

[idle_timeout]
timeout: 99999999

[virtual_sdcard]
path: /usr/data/printer_data/gcodes

[gcode_arcs]
resolution: 1.0

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor chamber_temp]
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 125

[duplicate_pin_override]
#pins: PC0, PC5
pins: PC0, PC5, nozzle_mcu:PB4, PC6, nozzle_mcu:PB3

[temperature_fan chamber_fan]
pin: PC0
cycle_time: 0.0100
hardware_pwm: false
max_power: 1
shutdown_speed: 0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 70
control: watermark
max_delta: 2
target_temp: 35.0
max_speed: 1.0
min_speed: 0.0

[stepper_x]
step_pin: PC2
dir_pin: !PB9
enable_pin: !PC3
microsteps: 32
rotation_distance: 72
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 229
position_min: -5
position_max: 229
homing_speed: 36
homing_retract_dist:0

[tmc2209 stepper_x]
uart_pin:PA9
interpolate: True
run_current:1.5
hold_current:1.0
sense_resistor: 0.100
stealthchop_threshold: 0
uart_address:3
diag_pin: ^PB12
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 0
# driver_HSTRT: 7
driver_SGTHRS: 65

[stepper_y]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PC3
microsteps: 32
rotation_distance: 72
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 5
position_min: 3
position_max: 226
homing_speed: 36
homing_retract_dist:0

[tmc2209 stepper_y]
uart_pin:PA10
interpolate: True
run_current:1.5
hold_current:1.0
sense_resistor: 0.100
stealthchop_threshold: 0
uart_address:3
diag_pin: ^PB13
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 0
# driver_HSTRT: 7
driver_SGTHRS: 65

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance:8
gear_ratio: 64:20
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 255
position_min: -5

[tmc2209 stepper_z]
uart_pin: PA11
uart_address: 3
run_current: 0.8
diag_pin: ^PB14
stealthchop_threshold: 0
sense_resistor: 0.100
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 2
# driver_HSTRT: 2
driver_SGTHRS: 0

[extruder]
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 80
step_pin: nozzle_mcu:PB1
dir_pin: nozzle_mcu:PB0
enable_pin: !nozzle_mcu:PB2
microsteps: 16
rotation_distance: 5.11
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nozzle_mcu:PB7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: nozzle_mcu:PA0
pressure_advance: 0.04
pressure_advance_smooth_time: 0.040
control: pid
pid_Kp: 25.013
pid_Ki: 2.566
pid_Kd: 60.966
min_temp: 0
max_temp: 320

[tmc2209 extruder]
uart_pin: nozzle_mcu:PB11
tx_pin: nozzle_mcu:PB10
uart_address: 3
run_current: 0.45
sense_resistor: 0.150
stealthchop_threshold: 0
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 2
# driver_TOFF: 3
# driver_HEND: 0
# driver_HSTRT: 5

[heater_bed]
heater_pin: PB10
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: watermark
# control: pid
# pid_kp: 27
# pid_ki: 0.08
# pid_kd: 0
min_temp: 0
max_temp: 115

[filament_switch_sensor filament_sensor]
pause_on_runout: true
switch_pin: !PC15
runout_gcode:
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G0 E30 F600
    G90
  {% endif %}

[filament_switch_sensor filament_sensor_2]
pause_on_runout: true
switch_pin: !nozzle_mcu:PA10

[multi_pin heater_fans]
pins:nozzle_mcu:PB5,PB2

[heater_fan hotend_fan]
pin: nozzle_mcu:PB5
heater: extruder
heater_temp: 45
#tachometer_pin: nozzle_mcu:PB4

[controller_fan controller]
pin: PB2
shutdown_speed: 1
fan_speed: 1.0
idle_timeout: 30
idle_speed: 0.8
heater: extruder, heater_bed
tachometer_pin: PC6

[fan]
pin: nozzle_mcu: PB6
#pin: !nozzle_mcu: PB8
shutdown_speed: 0
hardware_pwm: False
#tachometer_pin: nozzle_mcu:PB3
#enable_pin: nozzle_mcu: PB6

[fan_generic chamber_fan]
pin: PC0
cycle_time: 0.0100
hardware_pwm: false
shutdown_speed: 0.0

[fan_generic side_fan]
pin: PB1
cycle_time: 0.0100
hardware_pwm: False
kick_start_time: 0.500
shutdown_speed: 0.0
#off_below: 0.83

[output_pin LED]
pin:PB0
pwm: True
cycle_time: 0.010
value: 1

[adxl345]
cs_pin: nozzle_mcu:PA4
spi_speed: 5000000
axes_map: x,-z,y
spi_software_sclk_pin: nozzle_mcu:PA5
spi_software_mosi_pin: nozzle_mcu:PA7
spi_software_miso_pin: nozzle_mcu:PA6

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 75
# min_freq: 30
# max_freq: 100
probe_points:
   110,110,10

# [prtouch_v2]  # K1
# pr_version: 1
# step_base: 2
# z_offset: 0 
# noz_ex_com: 0.05
# tilt_corr_dis: 0.03
# tri_min_hold: 2000,20000
# tri_max_hold: 6000,60000
# pres_cnt: 4
# pres0_clk_pins: leveling_mcu:PA5
# pres0_sdo_pins: leveling_mcu:PA1
# pres1_clk_pins: leveling_mcu:PA2
# pres1_sdo_pins: leveling_mcu:PA0
# pres2_clk_pins: leveling_mcu:PA6
# pres2_sdo_pins: leveling_mcu:PA3
# pres3_clk_pins: leveling_mcu:PA7
# pres3_sdo_pins: leveling_mcu:PA4
# show_msg: False
# step_swap_pin: PC10
# pres_swap_pin: leveling_mcu:PB1
# g28_wait_cool_down: true
# pa_clr_down_mm: -0.15
# clr_noz_start_x: 95
# clr_noz_start_y: 221
# clr_noz_len_x: 40
# clr_noz_len_y: 2
# speeds: 2.5,1.0
# tri_hftr_cut: 2,1
# tri_lftr_k1: 0.70,0.30
# tri_try_max_times: 10
# tri_min_hold: 2000,20000
# tri_max_hold: 6000,60000

[bed_mesh]              # K1
zero_reference_position: 112,112
speed: 135              # recommended max 150 - absolute max 180. Going above 150 will cause mcu hanging / crashing or inconsistent spikey meshes due to bandwidth limitation.  
mesh_min: 30,25         # up to 30x30 if you have a weird spike bottom left of mesh
mesh_max: 210,210       # 210 max before hitting rear plate screws on stock bed
probe_count: 20,20      # tested 100x100 working
algorithm: bicubic      # required for above 5x5 meshing
bicubic_tension: 0.1

[display_status]

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 20000
minimum_cruise_ratio: 0.5
max_z_velocity: 20
square_corner_velocity: 5.0
max_z_accel: 300

[pause_resume]
# recover_velocity: 500.

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_y = ei
#*# shaper_freq_y = 67.8
#*# shaper_type_x = ei
#*# shaper_freq_x = 67.8
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.104121, 0.089254, 0.113827, 0.096804, 0.093250, 0.097093, 0.100756, 0.105593, 0.101189, 0.095062, 0.080082, 0.080051, 0.083780, 0.093497, 0.109776, 0.124883, 0.138600, 0.138578, 0.151216, 0.154264
#*# 	  0.066430, 0.077232, 0.080016, 0.075081, 0.070211, 0.070017, 0.071863, 0.075281, 0.073462, 0.065855, 0.061655, 0.060886, 0.061650, 0.072455, 0.087661, 0.104123, 0.109331, 0.115872, 0.126823, 0.125270
#*# 	  0.046085, 0.055765, 0.057896, 0.053220, 0.044705, 0.043149, 0.039201, 0.038640, 0.046074, 0.036284, 0.036183, 0.042355, 0.045805, 0.053732, 0.070329, 0.083669, 0.090966, 0.095851, 0.106629, 0.106127
#*# 	  0.027403, 0.039021, 0.041100, 0.037353, 0.025670, 0.021874, 0.021513, 0.021808, 0.016567, 0.018298, 0.021659, 0.027955, 0.035665, 0.044368, 0.060414, 0.075787, 0.081880, 0.088690, 0.098120, 0.099044
#*# 	  0.009560, 0.023014, 0.026628, 0.021743, 0.016320, 0.015863, 0.021021, 0.021217, 0.008753, 0.014205, 0.015512, 0.018875, 0.026212, 0.036333, 0.055489, 0.067590, 0.076244, 0.080589, 0.092387, 0.092808
#*# 	  -0.002370, 0.010123, 0.013797, 0.014897, 0.008823, 0.004667, 0.003931, 0.008715, 0.011676, 0.013570, 0.010687, 0.016251, 0.022365, 0.035273, 0.052734, 0.065998, 0.073265, 0.078148, 0.092304, 0.090761
#*# 	  -0.017744, -0.005898, 0.001517, 0.000360, 0.001230, 0.007107, 0.014847, 0.021080, 0.022342, 0.016941, 0.016022, 0.015590, 0.020913, 0.036094, 0.053560, 0.066723, 0.075275, 0.080108, 0.090473, 0.089896
#*# 	  -0.029550, -0.017674, -0.013045, -0.009626, -0.008493, 0.006000, 0.013532, 0.021909, 0.021692, 0.015684, 0.011014, 0.008770, 0.013825, 0.030950, 0.047511, 0.065387, 0.072995, 0.077133, 0.089748, 0.086550
#*# 	  -0.043387, -0.031564, -0.026636, -0.023529, -0.018107, -0.008566, 0.005964, 0.013573, 0.015051, 0.006301, 0.002276, 0.001502, 0.008705, 0.025259, 0.045750, 0.063379, 0.070855, 0.075324, 0.087777, 0.084210
#*# 	  -0.046747, -0.038671, -0.028761, -0.024366, -0.020875, -0.008332, 0.001370, 0.011132, 0.009117, 0.003998, 0.001298, 0.001588, 0.007857, 0.022662, 0.043160, 0.060996, 0.068131, 0.075056, 0.086915, 0.082525
#*# 	  -0.050326, -0.039982, -0.031570, -0.027268, -0.023649, -0.013855, -0.001339, 0.006495, 0.006585, 0.001514, 0.001156, 0.001544, 0.009536, 0.024860, 0.045566, 0.062824, 0.069933, 0.076494, 0.089395, 0.084921
#*# 	  -0.052281, -0.039940, -0.031613, -0.028652, -0.023944, -0.012876, -0.002239, 0.006401, 0.006155, 0.001460, 0.000383, 0.001509, 0.011229, 0.026096, 0.048259, 0.065361, 0.073078, 0.080083, 0.094133, 0.088795
#*# 	  -0.053424, -0.041039, -0.029035, -0.026917, -0.022839, -0.012695, 0.000986, 0.008164, 0.007739, 0.002036, 0.001264, 0.005732, 0.016063, 0.031863, 0.055757, 0.074026, 0.081223, 0.086772, 0.100043, 0.097531
#*# 	  -0.048747, -0.033624, -0.022439, -0.020796, -0.018237, -0.008160, 0.006542, 0.016041, 0.014026, 0.006474, 0.005229, 0.010842, 0.021800, 0.039895, 0.063369, 0.079973, 0.088827, 0.094988, 0.109732, 0.108654
#*# 	  -0.043580, -0.027746, -0.020677, -0.018548, -0.013280, -0.002299, 0.012468, 0.021679, 0.021472, 0.016554, 0.014498, 0.019128, 0.031117, 0.049980, 0.073507, 0.090199, 0.098354, 0.106911, 0.123012, 0.121705
#*# 	  -0.034460, -0.021337, -0.012975, -0.008787, -0.004657, 0.006574, 0.021400, 0.029901, 0.031215, 0.026181, 0.026216, 0.031145, 0.041165, 0.060477, 0.084214, 0.100896, 0.110277, 0.118622, 0.135111, 0.138124
#*# 	  -0.023404, -0.010138, -0.004055, -0.001093, 0.002783, 0.016820, 0.033635, 0.040921, 0.045550, 0.040740, 0.041083, 0.045831, 0.056584, 0.075185, 0.096972, 0.114225, 0.125492, 0.135233, 0.153022, 0.157795
#*# 	  -0.005948, 0.004335, 0.011596, 0.014507, 0.016788, 0.031128, 0.046399, 0.055637, 0.060092, 0.056086, 0.059869, 0.065288, 0.074986, 0.090782, 0.113900, 0.131064, 0.142996, 0.155875, 0.175288, 0.180844
#*# 	  0.018608, 0.028924, 0.032488, 0.034592, 0.040243, 0.050831, 0.066670, 0.077064, 0.081431, 0.084140, 0.084747, 0.090259, 0.101471, 0.117186, 0.139224, 0.156335, 0.170534, 0.181952, 0.201502, 0.210410
#*# 	  0.039927, 0.044970, 0.041729, 0.050198, 0.055494, 0.071233, 0.087322, 0.097989, 0.104141, 0.103740, 0.104685, 0.110090, 0.122348, 0.138917, 0.157470, 0.170941, 0.192213, 0.206526, 0.228268, 0.240480
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 25.0
#*# max_y = 210.0
#*#
#*# [prtouch default]
#*# version = 307
#*#
#*# [cartographer model default]
#*# model_coef = 1.5930592344022618,
#*# 	2.0157489908637873,
#*# 	0.6717700388038347,
#*# 	0.2976803319947483,
#*# 	0.5320226428175254,
#*# 	0.2672051914297084,
#*# 	-0.6100762842430485,
#*# 	-0.329439978850804,
#*# 	0.3669943814543373,
#*# 	0.2041047203008119
#*# model_domain = 3.249431970739381e-07,3.2916040167452457e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 34.820479
#*# model_offset = 0.00000
